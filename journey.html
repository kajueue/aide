<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>行程系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f5f2ed;
            color: #4a5553; 
            -webkit-font-smoothing: antialiased;
        }

        h1, h2, h3, label, button, span {
            font-weight: 500 !important;
        }

        /* 標題與內容顏色統一為 #5c6b65 */
        .title-once { 
            font-size: 20px !important; 
            line-height: 1.4; 
            color: #5c6b65 !important;
        }
        .title-weekly { 
            font-size: 18px !important; 
            line-height: 1.4; 
            color: #5c6b65 !important;
        }

        /* 備註顏色也同步為 #5c6b65 */
        .event-note-text, [id^="edit-note-"] {
            font-size: 18px !important;
            line-height: 1.6;
            font-weight: 500;
            color: #5c6b65 !important;
        }

        /* 彈出視窗輸入框 */
        #caseNote, #caseName { 
            font-size: 18px !important; 
            color: #5c6b65;
        }

        .case-card {
            transition: all 0.25s ease;
            background-color: #ffffff;
            display: flex;
            flex-direction: column;
        }

        .case-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(139, 126, 116, 0.1);
        }

        .editable-note {
            cursor: pointer;
            transition: background-color 0.2s;
            padding: 8px;
            border-radius: 8px;
        }
        .editable-note:hover { background-color: #faf9f7; }

        .type-btn-active { background-color: #8da399; color: white; border-color: #8da399; }

        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #8da399;
            border-radius: 50%;
            width: 12px; height: 12px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #modalContent {
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
    </style>
</head>
<body class="p-4 md:p-6 lg:p-8">

    <div class="max-w-5xl mx-auto">
        <header class="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
                <div class="flex items-center gap-2 mb-1">
                    <div class="p-1.5 bg-[#8da399] rounded-lg">
                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2-2v12a2 2 0 002 2z"></path></svg>
                    </div>
                    <h1 class="text-md text-[#5c6b65] tracking-tight">工作行程</h1>
                </div>
                <div class="flex items-center gap-2">
                    <p id="current-info" class="text-xs text-[#9ba8a4]"></p>
                    <div id="sync-status" class="flex items-center gap-1 text-[10px] text-[#8da399]">
                        <div class="loader"></div> 檢查中...
                    </div>
                </div>
            </div>
            <div class="flex gap-2">
                <button id="loginBtn" onclick="login()" class="hidden text-xs bg-white border border-[#e8e2da] px-3 py-2 rounded-lg text-[#5c6b65] hover:bg-[#faf9f7] shadow-sm transition">Google 登入同步</button>
                <button id="userBtn" class="hidden text-xs bg-[#f5f2ed] border border-[#e8e2da] px-3 py-2 rounded-lg text-[#8da399]" disabled></button>
                <button onclick="openModal()" class="bg-[#8da399] hover:bg-[#7a8f85] text-white px-5 py-2 rounded-lg shadow-sm transition-all text-sm flex items-center justify-center border border-[#a4b5ae]">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    新增行程
                </button>
            </div>
        </header>

        <main class="flex flex-col gap-12">
            <section>
                <div class="flex items-center gap-2 mb-4">
                    <span class="w-1.5 h-4 bg-[#8da399] rounded-full"></span>
                    <h2 class="text-md text-[#5c6b65]">今日待辦</h2>
                </div>
                <div id="today-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5"></div>
            </section>

            <section>
                <div class="flex items-center gap-2 mb-4">
                    <span class="w-1.5 h-4 bg-[#b5a48d] rounded-full"></span>
                    <h2 class="text-md text-[#b5a48d]">全部行程</h2>
                </div>
                <div id="all-cases-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5"></div>
            </section>
        </main>
    </div>

    <div id="caseModal" class="fixed inset-0 bg-[#4a5553]/30 hidden backdrop-blur-[1px] flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md overflow-hidden transition-all scale-95 opacity-0" id="modalContent">
            <div class="p-5">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="modalTitle" class="text-lg text-[#5c6b65]">建立行程</h2>
                    <button onclick="closeModal()" class="text-[#c8d1cd] hover:text-[#8da399] transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <form id="caseForm" class="space-y-4">
                    <input type="hidden" id="editId">
                    <input type="hidden" id="caseType" value="weekly">
                    
                    <div>
                        <label class="block text-xs text-[#7a8f85] mb-1.5 uppercase tracking-wide font-medium">行程類型</label>
                        <div class="flex gap-0 border border-[#e8e2da] rounded-lg overflow-hidden">
                            <button type="button" id="btnWeekly" onclick="setType('weekly')" class="flex-1 py-1.5 text-sm transition-colors type-btn-active">每週固定</button>
                            <button type="button" id="btnOnce" onclick="setType('once')" class="flex-1 py-1.5 text-sm transition-colors bg-[#faf9f7] text-[#9ba8a4]">單次預約</button>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs text-[#7a8f85] mb-1.5 uppercase tracking-wide font-medium">名稱</label>
                        <input type="text" id="caseName" required class="w-full border border-[#e8e2da] bg-[#faf9f7] rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-[#8da399]/20 transition" placeholder="例如：某某個案或會議">
                    </div>

                    <div id="weeklyOptions" class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs text-[#7a8f85] mb-1.5 uppercase tracking-wide font-medium">固定星期</label>
                            <select id="caseDay" class="w-full border border-[#e8e2da] bg-[#faf9f7] rounded-lg px-2 py-2 text-sm outline-none transition">
                                <option value="1">星期一</option>
                                <option value="2">星期二</option>
                                <option value="3">星期三</option>
                                <option value="4">星期四</option>
                                <option value="5">星期五</option>
                                <option value="6">星期六</option>
                                <option value="0">星期日</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs text-[#7a8f85] mb-1.5 uppercase tracking-wide font-medium">時段</label>
                            <select id="casePeriod" onchange="checkCustomTime('casePeriod', 'customTimeWeekly')" class="w-full border border-[#e8e2da] bg-[#faf9f7] rounded-lg px-2 py-2 text-sm outline-none transition">
                                <option value="0">早修</option>
                                <option value="1">第一節</option>
                                <option value="2">第二節</option>
                                <option value="3">第三節</option>
                                <option value="4">第四節</option>
                                <option value="5">午休</option>
                                <option value="6">第五節</option>
                                <option value="7">第六節</option>
                                <option value="8">第七節</option>
                                <option value="custom">自定義時間</option>
                            </select>
                            <input type="text" id="customTimeWeekly" class="hidden mt-1.5 w-full border border-[#e8e2da] bg-[#faf9f7] rounded-lg px-2 py-1.5 text-sm outline-none" placeholder="例如 08:30" onblur="formatCustomTime(this)">
                        </div>
                    </div>

                    <div id="onceOptions" class="grid grid-cols-2 gap-3 hidden">
                        <div>
                            <label class="block text-xs text-[#7a8f85] mb-1.5 uppercase tracking-wide font-medium">預約日期</label>
                            <input type="date" id="caseDate" class="w-full border border-[#e8e2da] bg-[#faf9f7] rounded-lg px-2 py-2 text-sm outline-none">
                        </div>
                        <div>
                            <label class="block text-xs text-[#7a8f85] mb-1.5 uppercase tracking-wide font-medium">時段</label>
                            <select id="casePeriodOnce" onchange="checkCustomTime('casePeriodOnce', 'customTimeOnce')" class="w-full border border-[#e8e2da] bg-[#faf9f7] rounded-lg px-2 py-2 text-sm outline-none">
                                <option value="0">早修</option>
                                <option value="1">第一節</option>
                                <option value="2">第二節</option>
                                <option value="3">第三節</option>
                                <option value="4">第四節</option>
                                <option value="5">午休</option>
                                <option value="6">第五節</option>
                                <option value="7">第六節</option>
                                <option value="8">第七節</option>
                                <option value="custom">自定義時間</option>
                            </select>
                            <input type="text" id="customTimeOnce" class="hidden mt-1.5 w-full border border-[#e8e2da] bg-[#faf9f7] rounded-lg px-2 py-1.5 text-sm outline-none" placeholder="例如 14:00" onblur="formatCustomTime(this)">
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs text-[#7a8f85] mb-1.5 uppercase tracking-wide font-medium">內容紀錄</label>
                        <textarea id="caseNote" rows="3" class="w-full border border-[#e8e2da] bg-[#faf9f7] rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-[#8da399]/20 transition" placeholder="輸入備註內容..."></textarea>
                    </div>

                    <div class="flex justify-end gap-3 pt-2">
                        <button type="button" onclick="closeModal()" class="px-4 py-2 text-sm text-[#8da399] font-medium hover:bg-[#f5f2ed] rounded-lg transition">取消</button>
                        <button type="submit" class="px-6 py-2 bg-[#8da399] text-white rounded-lg text-sm hover:bg-[#7a8f85] transition shadow-sm">儲存檔案</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyChKcQgRMId5U6T_5n4XrJOn1aVwonotHY",
            authDomain: "journey-b7ba3.firebaseapp.com",
            projectId: "journey-b7ba3",
            storageBucket: "journey-b7ba3.firebasestorage.app",
            messagingSenderId: "999872038815",
            appId: "1:999872038815:web:1a9e733f870b438fba5faa"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let caseList = [];
        let unsubscribe = null;
        const displayWeekDays = ["星期日", "星期一", "星期二", "星期三", "星期四", "星期五", "星期六"];
        const periodNames = ["早修", "第一節", "第二節", "第三節", "第四節", "午休", "第五節", "第六節", "第七節"];

        window.login = () => signInWithPopup(auth, provider).catch(console.error);

        onAuthStateChanged(auth, (user) => {
            const loginBtn = document.getElementById('loginBtn');
            const userBtn = document.getElementById('userBtn');
            if (user) {
                currentUser = user;
                loginBtn.classList.add('hidden');
                userBtn.classList.remove('hidden');
                userBtn.innerText = `${user.displayName}`;
                setupSync(user.uid);
            } else {
                loginBtn.classList.remove('hidden'); userBtn.classList.add('hidden');
                document.getElementById('today-container').innerHTML = '<div class="col-span-full py-10 text-center text-[#b5a48d]">請先登入以讀取雲端行程</div>';
                document.getElementById('sync-status').innerText = '尚未登入';
            }
        });

        function setupSync(uid) {
            if (unsubscribe) unsubscribe();
            const colRef = collection(db, 'users', uid, 'itineraries');
            unsubscribe = onSnapshot(colRef, (snapshot) => {
                caseList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                document.getElementById('sync-status').innerText = '雲端已同步';
                renderDisplay();
            });
        }

        function isPeriodExpired(period, customTimeValue) {
            const now = new Date();
            const currentHour = now.getHours();
            const currentMin = now.getMinutes();
            if (period === 'custom' && customTimeValue) {
                const parts = customTimeValue.split(':');
                if (parts.length === 2) {
                    const h = parseInt(parts[0]);
                    const m = parseInt(parts[1]);
                    return (currentHour > h) || (currentHour === h && currentMin >= m);
                }
            }
            const p = parseInt(period);
            if (p <= 4) return currentHour >= 12; // 早修到四節算中午前
            else return currentHour >= 17; // 其他算傍晚前
        }

        function renderDisplay() {
            const now = new Date();
            const todayNum = now.getDay();
            const todayStr = now.toISOString().split('T')[0];
            document.getElementById('current-info').innerHTML = `<span class="text-[#8da399] mr-2">${displayWeekDays[todayNum]}</span> <span class="text-[#b5a48d]/60 text-xs">${now.toLocaleDateString('zh-TW')}</span>`;
            
            const todayContainer = document.getElementById('today-container');
            const allContainer = document.getElementById('all-cases-container');
            todayContainer.innerHTML = ''; allContainer.innerHTML = '';

            const sortedList = [...caseList].sort((a, b) => {
                if (a.type !== b.type) return a.type === 'once' ? -1 : 1;
                return a.type === 'once' ? a.date.localeCompare(b.date) : a.day - b.day;
            });

            // 今日待辦：當天且未過期
            const todayPending = sortedList.filter(c => {
                const isToday = c.type === 'once' ? c.date === todayStr : c.day == todayNum;
                return isToday && !isPeriodExpired(c.period, c.customTime);
            });
            
            if (todayPending.length === 0) {
                todayContainer.innerHTML = `<div class="col-span-full py-10 text-center text-[#b5a48d]/50 text-sm">今日已無待辦行程</div>`;
            } else {
                todayPending.forEach(item => todayContainer.appendChild(createCard(item, true, false)));
            }

            // 全部行程
            if (sortedList.length === 0) {
                allContainer.innerHTML = `<div class="col-span-full py-10 text-center text-[#b5a48d]/40 text-sm">尚未建立行程資料</div>`;
            } else {
                sortedList.forEach(item => {
                    const isToday = item.type === 'once' ? item.date === todayStr : item.day == todayNum;
                    allContainer.appendChild(createCard(item, false, isToday && isPeriodExpired(item.period, item.customTime)));
                });
            }
        }

        function createCard(item, isPending, isExpired) {
            const card = document.createElement('div');
            card.className = `case-card rounded-xl border shadow-sm ${isExpired ? 'opacity-40' : 'opacity-100'} ${isPending ? 'border-[#8da399] ring-1 ring-[#8da399]/10' : 'border-[#e8e2da]'}`;
            const periodStr = item.period === 'custom' ? item.customTime : periodNames[item.period];
            const titleClass = item.type === 'once' ? 'title-once' : 'title-weekly';
            const note = item.note || '';

            card.innerHTML = `
                <div class="p-5 flex flex-col h-full">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <span class="text-[11px] text-[#9ba8a4] uppercase tracking-widest font-medium">${item.type === 'once' ? item.date.replace(/-/g, '/') : displayWeekDays[item.day]} · ${periodStr}</span>
                            <h3 class="${titleClass}">${item.name}</h3>
                        </div>
                        <div class="flex gap-1">
                            <button onclick="editCase('${item.id}')" class="p-1 text-[#b5a48d]/50 hover:text-[#8da399] transition"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></button>
                            <button onclick="deleteCase('${item.id}')" class="p-1 text-[#b5a48d]/50 hover:text-red-400 transition"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                        </div>
                    </div>
                    <div class="mt-auto">
                        <div id="display-note-${item.id}" onclick="startQuickEdit('${item.id}')" class="editable-note min-h-[40px] bg-[#faf9f7] ${!note ? 'border border-dashed border-[#e8e2da]' : ''}">
                           <p class="event-note-text whitespace-pre-line">${note}</p>
                        </div>
                        <textarea id="edit-note-${item.id}" class="hidden w-full border border-[#8da399] bg-white rounded-lg px-2.5 py-2 event-note-text outline-none" rows="2" onblur="saveQuickEdit('${item.id}')">${note}</textarea>
                    </div>
                </div>
            `;
            return card;
        }

        /* 視窗控制 */
        window.openModal = () => {
            document.getElementById('caseModal').classList.remove('hidden');
            setTimeout(() => document.getElementById('modalContent').classList.remove('scale-95', 'opacity-0'), 10);
            document.getElementById('caseForm').reset();
            document.getElementById('editId').value = '';
            document.getElementById('modalTitle').innerText = '建立行程';
            window.setType('weekly');
        };

        window.closeModal = () => {
            document.getElementById('modalContent').classList.add('scale-95', 'opacity-0');
            setTimeout(() => document.getElementById('caseModal').classList.add('hidden'), 200);
        };

        window.setType = (type) => {
            document.getElementById('caseType').value = type;
            document.getElementById('btnWeekly').className = type === 'weekly' ? "flex-1 py-1.5 text-sm transition-colors type-btn-active" : "flex-1 py-1.5 text-sm transition-colors bg-[#faf9f7] text-[#9ba8a4]";
            document.getElementById('btnOnce').className = type === 'once' ? "flex-1 py-1.5 text-sm transition-colors type-btn-active" : "flex-1 py-1.5 text-sm transition-colors bg-[#faf9f7] text-[#9ba8a4]";
            document.getElementById('weeklyOptions').classList.toggle('hidden', type !== 'weekly');
            document.getElementById('onceOptions').classList.toggle('hidden', type !== 'once');
        };

        window.checkCustomTime = (s, i) => document.getElementById(i).classList.toggle('hidden', document.getElementById(s).value !== 'custom');
        window.formatCustomTime = (i) => { if(i.value.length === 4 && !i.value.includes(':')) i.value = i.value.slice(0,2)+':'+i.value.slice(2); };

        window.editCase = (id) => {
            const item = caseList.find(c => c.id === id);
            if (!item) return;
            window.openModal();
            document.getElementById('editId').value = item.id;
            window.setType(item.type);
            document.getElementById('caseName').value = item.name;
            document.getElementById('caseNote').value = item.note || '';
            if (item.type === 'weekly') {
                document.getElementById('caseDay').value = item.day;
                document.getElementById('casePeriod').value = item.period;
                if(item.period === 'custom') { document.getElementById('customTimeWeekly').value = item.customTime; document.getElementById('customTimeWeekly').classList.remove('hidden'); }
            } else {
                document.getElementById('caseDate').value = item.date;
                document.getElementById('casePeriodOnce').value = item.period;
                if(item.period === 'custom') { document.getElementById('customTimeOnce').value = item.customTime; document.getElementById('customTimeOnce').classList.remove('hidden'); }
            }
        };

        window.deleteCase = async (id) => { if(confirm('確定要刪除此行程嗎？')) await deleteDoc(doc(db, 'users', currentUser.uid, 'itineraries', id)); };
        
        window.startQuickEdit = (id) => { 
            document.getElementById(`display-note-${id}`).classList.add('hidden'); 
            const e = document.getElementById(`edit-note-${id}`); 
            e.classList.remove('hidden'); 
            e.focus(); 
        };
        
        window.saveQuickEdit = async (id) => { 
            const n = document.getElementById(`edit-note-${id}`).value; 
            await setDoc(doc(db, 'users', currentUser.uid, 'itineraries', id), { note: n }, { merge: true }); 
        };

        document.getElementById('caseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if(!currentUser) return alert('請先登入');
            const type = document.getElementById('caseType').value;
            const id = document.getElementById('editId').value || Date.now().toString();
            const data = {
                type,
                name: document.getElementById('caseName').value,
                note: document.getElementById('caseNote').value,
                day: type === 'weekly' ? parseInt(document.getElementById('caseDay').value) : new Date(document.getElementById('caseDate').value).getDay(),
                period: type === 'weekly' ? document.getElementById('casePeriod').value : document.getElementById('casePeriodOnce').value,
                customTime: type === 'weekly' ? document.getElementById('customTimeWeekly').value : document.getElementById('customTimeOnce').value,
                date: type === 'once' ? document.getElementById('caseDate').value : null
            };
            await setDoc(doc(db, 'users', currentUser.uid, 'itineraries', id), data);
            window.closeModal();
        });

        setInterval(renderDisplay, 60000); // 每分鐘自動刷新一次（檢查過期狀態）
    </script>
</body>
</html>
