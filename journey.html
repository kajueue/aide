<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>行程管理系統 - 雲端版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f5f2ed;
            font-size: 1rem;
            color: #4a5553; 
            -webkit-font-smoothing: antialiased;
        }

        h1, h2, h3, label, button, span {
            font-weight: 500 !important;
        }

        .case-card {
            transition: all 0.25s ease;
            background-color: #ffffff;
            display: flex;
            flex-direction: column;
        }

        .event-title {
            font-size: 20px !important;
            line-height: 1.4;
            font-weight: 500;
        }

        .event-note-text {
            font-size: 16px !important;
            line-height: 1.6;
            font-weight: 500;
        }

        .case-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(139, 126, 116, 0.1);
        }

        .editable-note {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .editable-note:hover {
            background-color: #faf9f7;
        }

        .type-btn-active {
            background-color: #8da399;
            color: white;
            border-color: #8da399;
        }

        #modalContent {
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        .modal-body {
            overflow-y: auto;
        }
        
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #8da399;
            border-radius: 50%;
            width: 12px;
            height: 12px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* 自定義捲軸 */
        .modal-body::-webkit-scrollbar { width: 4px; }
        .modal-body::-webkit-scrollbar-thumb { background: #e8e2da; border-radius: 10px; }
    </style>
</head>
<body class="p-4 md:p-6 lg:p-8">

    <div class="max-w-5xl mx-auto">
        <header class="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
                <div class="flex items-center gap-2 mb-1">
                    <div class="p-1.5 bg-[#8da399] rounded-lg">
                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    </div>
                    <h1 class="text-md text-[#5c6b65] tracking-tight">雲端行程管理</h1>
                </div>
                <div class="flex items-center gap-2">
                    <p id="current-info" class="text-xs text-[#9ba8a4]"></p>
                    <div id="sync-status" class="flex items-center gap-1 text-[10px] text-[#8da399]">
                        <div class="loader"></div> 雲端連線中...
                    </div>
                </div>
                <p id="user-display" class="text-[10px] text-[#b5a48d] mt-1 opacity-60"></p>
            </div>
            <button onclick="openModal()" class="bg-[#8da399] hover:bg-[#7a8f85] text-white px-5 py-2 rounded-lg shadow-sm transition-all text-sm flex items-center justify-center border border-[#a4b5ae]">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                新增行程
            </button>
        </header>

        <main class="flex flex-col gap-12">
            <section>
                <div class="flex items-center gap-2 mb-4">
                    <span class="w-1.5 h-4 bg-[#8da399] rounded-full"></span>
                    <h2 class="text-md text-[#5c6b65]">今日待辦</h2>
                </div>
                <div id="today-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                    <div class="col-span-full py-10 text-center text-[#b5a48d]/50 text-sm">載入中...</div>
                </div>
            </section>

            <section>
                <div class="flex items-center gap-2 mb-4">
                    <span class="w-1.5 h-4 bg-[#b5a48d] rounded-full"></span>
                    <h2 class="text-md text-[#b5a48d]">全部行程</h2>
                </div>
                <div id="all-cases-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                </div>
            </section>
        </main>
    </div>

    <!-- Modal -->
    <div id="caseModal" class="fixed inset-0 bg-[#4a5553]/30 hidden backdrop-blur-[1px] flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md overflow-hidden transition-all scale-95 opacity-0" id="modalContent">
            <div class="p-5 modal-body">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="modalTitle" class="text-lg text-[#5c6b65]">建立行程檔案</h2>
                    <button onclick="closeModal()" class="text-[#c8d1cd] hover:text-[#8da399] transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <form id="caseForm" class="space-y-4">
                    <input type="hidden" id="editId">
                    <input type="hidden" id="caseType" value="weekly">
                    
                    <div>
                        <label class="block text-xs text-[#7a8f85] mb-1.5 uppercase tracking-wide font-medium">行程類型</label>
                        <div class="flex gap-0 border border-[#e8e2da] rounded-lg overflow-hidden">
                            <button type="button" id="btnWeekly" onclick="setType('weekly')" class="flex-1 py-1.5 text-sm transition-colors type-btn-active">每週固定</button>
                            <button type="button" id="btnOnce" onclick="setType('once')" class="flex-1 py-1.5 text-sm transition-colors bg-[#faf9f7] text-[#9ba8a4]">單次預約</button>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs text-[#7a8f85] mb-1.5 uppercase tracking-wide font-medium">名稱</label>
                        <input type="text" id="caseName" required class="w-full border border-[#e8e2da] bg-[#faf9f7] rounded-lg px-3 py-2 text-base focus:ring-2 focus:ring-[#8da399]/20 outline-none transition" placeholder="例如：數學課、診所預約">
                    </div>

                    <div id="weeklyOptions" class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs text-[#7a8f85] mb-1.5 uppercase tracking-wide font-medium">固定星期</label>
                            <select id="caseDay" class="w-full border border-[#e8e2da] bg-[#faf9f7] rounded-lg px-2 py-2 text-sm focus:ring-2 focus:ring-[#8da399]/20 outline-none transition">
                                <option value="1">星期一</option>
                                <option value="2">星期二</option>
                                <option value="3">星期三</option>
                                <option value="4">星期四</option>
                                <option value="5">星期五</option>
                                <option value="6">星期六</option>
                                <option value="0">星期日</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs text-[#7a8f85] mb-1.5 uppercase tracking-wide font-medium">時段</label>
                            <select id="casePeriod" onchange="checkCustomTime('casePeriod', 'customTimeWeekly')" class="w-full border border-[#e8e2da] bg-[#faf9f7] rounded-lg px-2 py-2 text-sm focus:ring-2 focus:ring-[#8da399]/20 outline-none transition">
                                <option value="0">早修</option>
                                <option value="1">第一節</option>
                                <option value="2">第二節</option>
                                <option value="3">第三節</option>
                                <option value="4">第四節</option>
                                <option value="5">午休</option>
                                <option value="6">第五節</option>
                                <option value="7">第六節</option>
                                <option value="8">第七節</option>
                                <option value="custom">自定義時間</option>
                            </select>
                            <input type="text" id="customTimeWeekly" class="hidden mt-1.5 w-full border border-[#e8e2da] bg-[#faf9f7] rounded-lg px-2 py-1.5 text-sm focus:ring-2 focus:ring-[#8da399]/20 outline-none transition" onblur="formatCustomTime(this)" placeholder="HH:MM">
                        </div>
                    </div>

                    <div id="onceOptions" class="grid grid-cols-2 gap-3 hidden">
                        <div>
                            <label class="block text-xs text-[#7a8f85] mb-1.5 uppercase tracking-wide font-medium">預約日期</label>
                            <input type="date" id="caseDate" class="w-full border border-[#e8e2da] bg-[#faf9f7] rounded-lg px-2 py-2 text-sm focus:ring-2 focus:ring-[#8da399]/20 outline-none transition">
                        </div>
                        <div>
                            <label class="block text-xs text-[#7a8f85] mb-1.5 uppercase tracking-wide font-medium">時段</label>
                            <select id="casePeriodOnce" onchange="checkCustomTime('casePeriodOnce', 'customTimeOnce')" class="w-full border border-[#e8e2da] bg-[#faf9f7] rounded-lg px-2 py-2 text-sm focus:ring-2 focus:ring-[#8da399]/20 outline-none transition">
                                <option value="0">早修</option>
                                <option value="1">第一節</option>
                                <option value="2">第二節</option>
                                <option value="3">第三節</option>
                                <option value="4">第四節</option>
                                <option value="5">午休</option>
                                <option value="6">第五節</option>
                                <option value="7">第六節</option>
                                <option value="8">第七節</option>
                                <option value="custom">自定義時間</option>
                            </select>
                            <input type="text" id="customTimeOnce" class="hidden mt-1.5 w-full border border-[#e8e2da] bg-[#faf9f7] rounded-lg px-2 py-1.5 text-sm focus:ring-2 focus:ring-[#8da399]/20 outline-none transition" onblur="formatCustomTime(this)" placeholder="HH:MM">
                        </div>
                    </div>

                    <div id="noteContainer">
                        <label class="block text-xs text-[#7a8f85] mb-1.5 uppercase tracking-wide font-medium">內容紀錄</label>
                        <textarea id="caseNote" rows="3" class="w-full border border-[#e8e2da] bg-[#faf9f7] rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-[#8da399]/20 outline-none transition" placeholder="備註行程細節..."></textarea>
                    </div>

                    <div class="flex justify-end gap-3 pt-2">
                        <button type="button" onclick="closeModal()" class="px-4 py-2 text-sm text-[#8da399] font-medium hover:bg-[#f5f2ed] rounded-lg transition">取消</button>
                        <button type="submit" class="px-6 py-2 bg-[#8da399] text-white rounded-lg text-sm hover:bg-[#7a8f85] transition shadow-sm">儲存檔案</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // Firebase 初始化與環境配置
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'itinerary-manager-demo';

        let currentUser = null;
        let caseList = [];
        const displayWeekDays = ["星期日", "星期一", "星期二", "星期三", "星期四", "星期五", "星期六"];
        const periodNames = ["早修", "第一節", "第二節", "第三節", "第四節", "午休", "第五節", "第六節", "第七節"];

        // 身份認證啟動
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth error:", error);
                document.getElementById('sync-status').innerHTML = `<span class="text-red-400">連線失敗</span>`;
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('user-display').innerText = `Sync ID: ${user.uid}`;
                setupSync();
            }
        });

        // 雲端即時同步
        function setupSync() {
            if (!currentUser) return;
            // 遵循 RULE 1 的路徑規範
            const collectionPath = `artifacts/${appId}/users/${currentUser.uid}/itineraries`;
            const collectionRef = collection(db, collectionPath);
            
            // 使用 onSnapshot 監聽變化，遵循 RULE 2 不使用複雜 Query
            onSnapshot(collectionRef, (snapshot) => {
                caseList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateSyncUI(true);
                renderDisplay();
            }, (error) => {
                console.error("Sync error:", error);
                updateSyncUI(false);
            });
        }

        function updateSyncUI(success) {
            const statusEl = document.getElementById('sync-status');
            if (success) {
                statusEl.innerHTML = `
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> 
                    雲端已同步
                `;
            } else {
                statusEl.innerHTML = `<span class="text-red-400">連線中斷</span>`;
            }
        }

        // 渲染邏輯
        function renderDisplay() {
            const now = new Date();
            const todayNum = now.getDay();
            const todayStr = now.toISOString().split('T')[0];
            
            document.getElementById('current-info').innerHTML = `
                <span class="text-[#8da399] mr-2">${displayWeekDays[todayNum]}</span> 
                <span class="text-[#b5a48d]/60 text-xs">${now.toLocaleDateString('zh-TW')}</span>
            `;

            const todayContainer = document.getElementById('today-container');
            const allContainer = document.getElementById('all-cases-container');
            
            todayContainer.innerHTML = '';
            allContainer.innerHTML = '';

            // 前端排序與過濾
            const sortedList = [...caseList].sort((a, b) => {
                // 先排類型 (單次優先)
                if (a.type !== b.type) return a.type === 'once' ? -1 : 1;
                // 單次按日期排
                if (a.type === 'once') return a.date.localeCompare(b.date);
                // 固定按星期排
                return a.day - b.day;
            });

            // 過濾出今日未過期的待辦
            const todayPendingCases = sortedList.filter(c => {
                const isExpired = isPeriodExpired(c.period, c.customTime);
                if (c.type === 'once') return c.date === todayStr && !isExpired;
                return c.day == todayNum && !isExpired;
            });

            if (todayPendingCases.length === 0) {
                todayContainer.innerHTML = `<div class="col-span-full py-10 text-center text-[#b5a48d]/50 text-sm bg-white/50 rounded-xl border border-dashed border-[#e8e2da]">今日無待辦行程</div>`;
            } else {
                todayPendingCases.forEach(item => todayContainer.appendChild(createCard(item, true)));
            }

            if (sortedList.length === 0) {
                allContainer.innerHTML = `<div class="col-span-full py-10 text-center text-[#b5a48d]/40 text-sm">尚未建立任何行程。點擊右上角「新增行程」開始。</div>`;
            } else {
                sortedList.forEach(item => {
                    let isToday = (item.type === 'once') ? (item.date === todayStr) : (item.day == todayNum);
                    const isExpired = isToday && isPeriodExpired(item.period, item.customTime);
                    allContainer.appendChild(createCard(item, false, isExpired));
                });
            }
        }

        // 判斷時段是否已過期
        function isPeriodExpired(period, customTimeValue) {
            const now = new Date();
            const currentHour = now.getHours();
            const currentMin = now.getMinutes();
            if (period === 'custom' && customTimeValue) {
                const parts = customTimeValue.split(':');
                if (parts.length === 2) {
                    const h = parseInt(parts[0]);
                    const m = parseInt(parts[1]);
                    return (currentHour > h) || (currentHour === h && currentMin >= m);
                }
            }
            const p = parseInt(period);
            if (isNaN(p)) return false; 
            // 簡易判斷：早修到第四節算上午(12:00)，午休後算下午(17:00)
            if (p <= 4) return currentHour >= 12;
            else return currentHour >= 17;
        }

        // 產生卡片 HTML
        function createCard(item, isPendingToday, isExpiredToday = false) {
            const card = document.createElement('div');
            const opacityClass = isExpiredToday ? 'opacity-50 grayscale-[0.3]' : 'opacity-100';
            const isOnce = item.type === 'once';
            card.className = `case-card bg-white rounded-xl border shadow-sm ${opacityClass} ${isPendingToday ? 'border-[#8da399] ring-2 ring-[#8da399]/10' : 'border-[#e8e2da]'}`;
            
            const periodStr = item.period === 'custom' ? item.customTime : periodNames[item.period];
            const timeLabel = isOnce 
                ? `${item.date.replace(/-/g, '/')} (${displayWeekDays[new Date(item.date).getDay()]}) · ${periodStr}`
                : `${displayWeekDays[item.day]} · ${periodStr}`;

            const hasNote = item.note && item.note.trim() !== '';
            const displayNote = hasNote ? item.note : '無備註內容...';

            card.innerHTML = `
                <div class="p-5 flex flex-col h-full min-h-[140px]">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <div class="flex items-center gap-1.5 mb-1">
                                <span class="w-1.5 h-1.5 rounded-full ${isPendingToday ? 'bg-[#8da399] animate-pulse' : (isExpiredToday ? 'bg-gray-300' : 'bg-[#b5a48d]')}"></span>
                                <span class="text-[11px] text-[#9ba8a4] uppercase tracking-widest font-medium">${timeLabel}</span>
                            </div>
                            <h3 class="event-title text-[#5c6b65]">${item.name}</h3>
                        </div>
                        <div class="flex gap-1 ml-2">
                            <button onclick="window.editCase('${item.id}')" class="p-1.5 text-[#b5a48d]/40 hover:text-[#8da399] transition">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                            </button>
                            <button onclick="window.deleteCase('${item.id}')" class="p-1.5 text-[#b5a48d]/40 hover:text-red-400 transition">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    </div>
                    <div class="note-wrapper mt-auto">
                        <div id="display-note-${item.id}" onclick="window.startQuickEdit('${item.id}')" class="editable-note min-h-[40px] bg-[#faf9f7] rounded-lg p-3 ${!hasNote ? 'border border-dashed border-[#e8e2da]' : ''}">
                           <p class="event-note-text text-[#2c3331] whitespace-pre-line">${displayNote}</p>
                        </div>
                        <textarea id="edit-note-${item.id}" class="hidden w-full border border-[#8da399] bg-white rounded-lg px-3 py-2 event-note-text text-[#2c3331] outline-none transition" rows="3" onblur="window.saveQuickEdit('${item.id}')">${item.note || ''}</textarea>
                    </div>
                </div>
            `;
            return card;
        }

        // Global Window Functions
        window.openModal = () => {
            const modal = document.getElementById('caseModal');
            const modalContent = document.getElementById('modalContent');
            modal.classList.remove('hidden');
            setTimeout(() => modalContent.classList.remove('scale-95', 'opacity-0'), 10);
            document.getElementById('caseForm').reset();
            document.getElementById('editId').value = '';
            document.getElementById('modalTitle').innerText = '建立行程檔案';
            window.setType('weekly');
        };

        window.closeModal = () => {
            const modal = document.getElementById('caseModal');
            const modalContent = document.getElementById('modalContent');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 200);
        };

        window.setType = (type) => {
            document.getElementById('caseType').value = type;
            const btnWeekly = document.getElementById('btnWeekly');
            const btnOnce = document.getElementById('btnOnce');
            const weeklyOptions = document.getElementById('weeklyOptions');
            const onceOptions = document.getElementById('onceOptions');
            if (type === 'weekly') {
                btnWeekly.className = "flex-1 py-1.5 text-sm transition-colors type-btn-active";
                btnOnce.className = "flex-1 py-1.5 text-sm transition-colors bg-[#faf9f7] text-[#9ba8a4]";
                weeklyOptions.classList.remove('hidden'); onceOptions.classList.add('hidden');
            } else {
                btnOnce.className = "flex-1 py-1.5 text-sm transition-colors type-btn-active";
                btnWeekly.className = "flex-1 py-1.5 text-sm transition-colors bg-[#faf9f7] text-[#9ba8a4]";
                weeklyOptions.classList.add('hidden'); onceOptions.classList.remove('hidden');
            }
        };

        window.checkCustomTime = (selectId, inputId) => {
            const select = document.getElementById(selectId);
            const input = document.getElementById(inputId);
            if (select.value === 'custom') { input.classList.remove('hidden'); input.focus(); } 
            else { input.classList.add('hidden'); }
        };

        window.formatCustomTime = (input) => {
            let val = input.value.replace(/[^0-9:]/g, '');
            if (val.length === 4 && !val.includes(':')) val = val.substring(0, 2) + ':' + val.substring(2);
            input.value = val;
        };

        window.editCase = (id) => {
            const item = caseList.find(c => c.id === id);
            if (!item) return;
            window.openModal();
            document.getElementById('editId').value = item.id;
            window.setType(item.type);
            document.getElementById('caseName').value = item.name;
            document.getElementById('caseNote').value = item.note || '';
            if (item.type === 'weekly') {
                document.getElementById('caseDay').value = item.day;
                document.getElementById('casePeriod').value = item.period;
                if(item.period === 'custom') {
                    const customInput = document.getElementById('customTimeWeekly');
                    customInput.classList.remove('hidden');
                    customInput.value = item.customTime || '';
                }
            } else {
                document.getElementById('caseDate').value = item.date;
                document.getElementById('casePeriodOnce').value = item.period;
                if(item.period === 'custom') {
                    const customInput = document.getElementById('customTimeOnce');
                    customInput.classList.remove('hidden');
                    customInput.value = item.customTime || '';
                }
            }
            document.getElementById('modalTitle').innerText = '編輯行程檔案';
        };

        window.deleteCase = async (id) => {
            if (!currentUser) return;
            // 自定義彈窗而非使用不可控的 alert
            if (confirm('確定要刪除此行程嗎？')) {
                const docRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'itineraries', id);
                await deleteDoc(docRef);
            }
        };

        window.startQuickEdit = (id) => {
            const displayEl = document.getElementById(`display-note-${id}`);
            const editEl = document.getElementById(`edit-note-${id}`);
            displayEl.classList.add('hidden'); 
            editEl.classList.remove('hidden'); 
            editEl.focus();
        };

        window.saveQuickEdit = async (id) => {
            if (!currentUser) return;
            const editEl = document.getElementById('edit-note-' + id);
            const displayEl = document.getElementById('display-note-' + id);
            const newNote = editEl.value;
            
            displayEl.classList.remove('hidden');
            editEl.classList.add('hidden');

            const docRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'itineraries', id);
            await setDoc(docRef, { note: newNote, updatedAt: new Date() }, { merge: true });
        };

        // 表單提交處理
        document.getElementById('caseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return;
            
            const type = document.getElementById('caseType').value;
            const name = document.getElementById('caseName').value;
            const note = document.getElementById('caseNote').value;
            const editId = document.getElementById('editId').value || Date.now().toString();
            
            let data = { 
                type, 
                name, 
                note,
                updatedAt: new Date() 
            };

            if (type === 'weekly') {
                data.day = parseInt(document.getElementById('caseDay').value);
                data.period = document.getElementById('casePeriod').value;
                data.customTime = data.period === 'custom' ? document.getElementById('customTimeWeekly').value : null;
            } else {
                data.date = document.getElementById('caseDate').value;
                data.period = document.getElementById('casePeriodOnce').value;
                data.customTime = data.period === 'custom' ? document.getElementById('customTimeOnce').value : null;
                data.day = new Date(data.date).getDay();
            }

            const docPath = `artifacts/${appId}/users/${currentUser.uid}/itineraries/${editId}`;
            const docRef = doc(db, docPath);
            await setDoc(docRef, data, { merge: true });
            window.closeModal();
        });

        // 定期重新渲染（確保「過期」狀態更新）
        initAuth();
        setInterval(renderDisplay, 60000);
    </script>
</body>
</html>
