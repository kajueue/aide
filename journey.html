<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“</text></svg>">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡Œç¨‹ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
<style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f5f2ed;
            font-size: 1rem;
            color: #4a5553; 
            -webkit-font-smoothing: antialiased;
        }

        h1, h2, h3, label, button, span {
            font-weight: 500 !important;
        }

        .case-card {
            transition: all 0.25s ease;
            background-color: #ffffff;
            display: flex;
            flex-direction: column;
        }

        /* æ¨™é¡Œé¡è‰²çµ±ä¸€ç‚ºæ·±ç°ç¶  #5c6b65 */
        .title-once { 
            font-size: 20px !important; 
            line-height: 1.4; 
            font-weight: 500;
            color: #5c6b65 !important;
        }

        .title-weekly { 
            font-size: 18px !important; 
            line-height: 1.4; 
            font-weight: 500;
            color: #5c6b65 !important;
        }

        /* å…§å®¹ç´€éŒ„ï¼ˆå‚™è¨»ï¼‰ï¼šè¨­å®šèˆ‡æ¨™é¡Œä¸€æ¨£çš„é¡è‰² #5c6b65 */
        .event-note-text {
            font-size: 18px !important;
            line-height: 1.6;
            font-weight: 500;
            color: #5c6b65 !important;
        }

        /* å¿«é€Ÿç·¨è¼¯æ™‚çš„è¼¸å…¥æ¡†é¡è‰²ä¹ŸåŒæ­¥ */
        [id^="edit-note-"] {
            font-size: 18px !important;
            color: #5c6b65 !important;
            font-weight: 500;
        }

        .case-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(139, 126, 116, 0.1);
        }

        .editable-note {
            cursor: pointer;
            transition: background-color 0.2s;
            padding: 8px;
            border-radius: 8px;
        }
        .editable-note:hover {
            background-color: #faf9f7;
        }

        .type-btn-active {
            background-color: #8da399;
            color: white;
            border-color: #8da399;
        }

        #modalContent {
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        .modal-body {
            overflow-y: auto;
        }
        
        /* ç™»å…¥é®ç½© */
        #auth-overlay {
            position: fixed;
            inset: 0;
            background: #f5f2ed;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            transition: opacity 0.3s ease;
        }

        .hidden-auth {
            opacity: 0;
            pointer-events: none;
        }
/* ä¿®æ”¹å¡ç‰‡å…§ç·¨è¼¯æ¡†ï¼šç§»é™¤å›ºå®šé«˜åº¦ï¼Œæ”¹ç”¨æœ€å°é«˜åº¦ */
[id^="edit-note-"] {
    min-height: 32px !important;  /* é è¨­ç¶­æŒä¸€è¡Œçš„é«˜åº¦ */
    height: auto;                 /* ç§»é™¤å›ºå®š 32pxï¼Œè®“ JS å¯ä»¥æ§åˆ¶é«˜åº¦ */
    padding-top: 4px !important;
    padding-bottom: 4px !important;
    line-height: 1.4 !important;
    resize: none !important;
    overflow: hidden !important;  /* éš±è—æ²è»¸ï¼Œçœ‹èµ·ä¾†æ›´åƒè‡ªç„¶æ’é–‹ */
    display: block;
}
/* ç¢ºä¿ã€Œå»ºç«‹è¡Œç¨‹ã€å½ˆå‡ºè¦–çª—è£¡çš„è¼¸å…¥æ¡†æ¢å¾©æ­£å¸¸é¡¯ç¤º */
#caseNote {
    min-height: 80px !important;  /* å½ˆå‡ºè¦–çª—çš„æ¡†è¦å¤ å¤§ */
    height: auto !important;
    padding: 8px !important;
    display: block !important;    /* ç¢ºä¿å®ƒä¸æ˜¯ hidden */
    visibility: visible !important;
}

/* åŒæ­¥èª¿æ•´å¡ç‰‡é è¦½ç‹€æ…‹çš„é«˜åº¦ */
.editable-note {
    min-height: 32px !important;
    padding: 4px 8px !important;
    display: flex;
    align-items: center;
}
    </style>
</head>
<body class="p-4 md:p-6 lg:p-8">

    <!-- ç™»å…¥ä»‹é¢ -->
    <div id="auth-overlay">
        <div class="text-center p-8 bg-white rounded-3xl shadow-xl max-w-sm w-full mx-4">
            <div class="w-16 h-16 bg-[#8da399] rounded-2xl flex items-center justify-center mx-auto mb-6">
                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2-2v12a2 2 0 002 2z"></path></svg>
            </div>
            <h2 class="text-xl font-bold text-[#5c6b65] mb-2">é›²ç«¯è¡Œç¨‹åŒæ­¥</h2>
            <p class="text-xs text-[#9ba8a4] mb-8">è«‹ç™»å…¥ Google å¸³è™Ÿä»¥é–‹å§‹åŒæ­¥æ‚¨çš„è¡Œç¨‹</p>
            <button id="btn-login" class="w-full flex items-center justify-center gap-3 bg-white border border-[#e8e2da] py-3 rounded-xl hover:bg-gray-50 transition-all font-medium text-[#5c6b65]">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5">
                ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥
            </button>
            <div id="auth-error" class="mt-4 text-red-400 text-xs hidden"></div>
        </div>
    </div>

    <!-- ä¸»ä»‹é¢ -->
    <div id="main-app" class="max-w-5xl mx-auto opacity-0 transition-opacity duration-500">
        <header class="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
                <div class="flex items-center gap-2 mb-1">
                    <div class="p-1.5 bg-[#8da399] rounded-lg">
                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2-2v12a2 2 0 002 2z"></path></svg>
                    </div>
                    <h1 class="text-md text-[#5c6b65] tracking-tight">å·¥ä½œè¡Œç¨‹</h1>
                    <button id="btn-logout" class="ml-2 text-[10px] text-gray-400 hover:text-red-400 underline">ç™»å‡º</button>
                </div>
                <div class="flex items-center gap-2">
                    <p id="current-info" class="text-xs text-[#9ba8a4]"></p>
                    <div id="sync-status" class="hidden"></div>
                </div>
                <p id="user-display" class="hidden"></p>
            </div>
            <button onclick="openModal()" class="bg-[#8da399] hover:bg-[#7a8f85] text-white px-5 py-2 rounded-lg shadow-sm transition-all text-sm flex items-center justify-center border border-[#a4b5ae]">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                æ–°å¢è¡Œç¨‹
            </button>
        </header>

        <main class="flex flex-col gap-12">
            <section>
                <div class="flex items-center gap-2 mb-4">
                    <span class="w-1.5 h-4 bg-[#8da399] rounded-full"></span>
                    <h2 class="text-md text-[#5c6b65]">ä»Šæ—¥å¾…è¾¦</h2>
                </div>
                <div id="today-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5"></div>
            </section>

            <section>
                <div class="flex items-center gap-2 mb-4">
                    <span class="w-1.5 h-4 bg-[#b5a48d] rounded-full"></span>
                    <h2 class="text-md text-[#b5a48d]">å…¨éƒ¨è¡Œç¨‹</h2>
                </div>
                <div id="all-cases-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5"></div>
            </section>
        </main>
    </div>

    <!-- Modal å½ˆçª— -->
    <div id="caseModal" class="fixed inset-0 bg-[#4a5553]/30 hidden backdrop-blur-[1px] flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md overflow-hidden transition-all scale-95 opacity-0" id="modalContent">
            <div class="p-5 modal-body">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="modalTitle" class="text-lg text-[#5c6b65]">å»ºç«‹è¡Œç¨‹</h2>
                    <button onclick="closeModal()" class="text-[#c8d1cd] hover:text-[#8da399] transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <form id="caseForm" class="space-y-4">
                    <input type="hidden" id="editId">
                    <input type="hidden" id="caseType" value="weekly">
                    
                    <div>
                        <label class="block text-xs text-[#7a8f85] mb-1.5 uppercase tracking-wide font-medium">è¡Œç¨‹é¡å‹</label>
                        <div class="flex gap-0 border border-[#e8e2da] rounded-lg overflow-hidden">
                            <button type="button" id="btnWeekly" onclick="setType('weekly')" class="flex-1 py-1.5 text-sm transition-colors type-btn-active">æ¯é€±å›ºå®š</button>
                            <button type="button" id="btnOnce" onclick="setType('once')" class="flex-1 py-1.5 text-sm transition-colors bg-[#faf9f7] text-[#9ba8a4]">å–®æ¬¡é ç´„</button>
                        </div>
                    </div>

                    <div>
                        <label id="labelName" class="block text-xs text-[#7a8f85] mb-1.5 uppercase tracking-wide font-medium">åç¨±</label>
                        <!-- æ ¸å¿ƒä¿®æ”¹ 1: autocomplete="off" ç¦æ­¢ç€è¦½å™¨ç´€éŒ„ -->
                        <input type="text" id="caseName" required autocomplete="off" class="w-full border border-[#e8e2da] bg-[#faf9f7] rounded-lg px-3 py-2 text-base focus:ring-2 focus:ring-[#8da399]/20 outline-none transition" placeholder="è¼¸å…¥åç¨±">
                    </div>

                    <div id="weeklyOptions" class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs text-[#7a8f85] mb-1.5 uppercase tracking-wide font-medium">å›ºå®šæ˜ŸæœŸ</label>
                            <select id="caseDay" class="w-full border border-[#e8e2da] bg-[#faf9f7] rounded-lg px-2 py-2 text-sm focus:ring-2 focus:ring-[#8da399]/20 outline-none transition">
                                <option value="1">æ˜ŸæœŸä¸€</option>
                                <option value="2">æ˜ŸæœŸäºŒ</option>
                                <option value="3">æ˜ŸæœŸä¸‰</option>
                                <option value="4">æ˜ŸæœŸå››</option>
                                <option value="5">æ˜ŸæœŸäº”</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs text-[#7a8f85] mb-1.5 uppercase tracking-wide font-medium">æ™‚æ®µ</label>
                            <select id="casePeriod" onchange="checkCustomTime('casePeriod', 'customTimeWeekly')" class="w-full border border-[#e8e2da] bg-[#faf9f7] rounded-lg px-2 py-2 text-sm focus:ring-2 focus:ring-[#8da399]/20 outline-none transition">
                                <option value="0">æ—©ä¿®</option>
                                <option value="1">ç¬¬ä¸€ç¯€</option>
                                <option value="2">ç¬¬äºŒç¯€</option>
                                <option value="3">ç¬¬ä¸‰ç¯€</option>
                                <option value="4">ç¬¬å››ç¯€</option>
                                <option value="5">åˆä¼‘</option>
                                <option value="6">ç¬¬äº”ç¯€</option>
                                <option value="7">ç¬¬å…­ç¯€</option>
                                <option value="8">ç¬¬ä¸ƒç¯€</option>
                                <option value="custom">è‡ªå®šç¾©æ™‚é–“</option>
                            </select>
                            <input type="text" id="customTimeWeekly" autocomplete="off" class="hidden mt-1.5 w-full border border-[#e8e2da] bg-[#faf9f7] rounded-lg px-2 py-1.5 text-sm focus:ring-2 focus:ring-[#8da399]/20 outline-none transition" placeholder="HH:mm" onblur="formatCustomTime(this)">
                        </div>
                    </div>

                    <div id="onceOptions" class="grid grid-cols-2 gap-3 hidden">
                        <div>
                            <label class="block text-xs text-[#7a8f85] mb-1.5 uppercase tracking-wide font-medium">é ç´„æ—¥æœŸ</label>
                            <input type="date" id="caseDate" class="w-full border border-[#e8e2da] bg-[#faf9f7] rounded-lg px-2 py-2 text-sm focus:ring-2 focus:ring-[#8da399]/20 outline-none transition">
                        </div>
                        <div>
                            <label class="block text-xs text-[#7a8f85] mb-1.5 uppercase tracking-wide font-medium">æ™‚æ®µ</label>
                            <select id="casePeriodOnce" onchange="checkCustomTime('casePeriodOnce', 'customTimeOnce')" class="w-full border border-[#e8e2da] bg-[#faf9f7] rounded-lg px-2 py-2 text-sm focus:ring-2 focus:ring-[#8da399]/20 outline-none transition">
                                <option value="0">æ—©ä¿®</option>
                                <option value="1">ç¬¬ä¸€ç¯€</option>
                                <option value="2">ç¬¬äºŒç¯€</option>
                                <option value="3">ç¬¬ä¸‰ç¯€</option>
                                <option value="4">ç¬¬å››ç¯€</option>
                                <option value="5">åˆä¼‘</option>
                                <option value="6">ç¬¬äº”ç¯€</option>
                                <option value="7">ç¬¬å…­ç¯€</option>
                                <option value="8">ç¬¬ä¸ƒç¯€</option>
                                <option value="custom">è‡ªå®šç¾©æ™‚é–“</option>
                            </select>
                            <input type="text" id="customTimeOnce" autocomplete="off" class="hidden mt-1.5 w-full border border-[#e8e2da] bg-[#faf9f7] rounded-lg px-2 py-1.5 text-sm focus:ring-2 focus:ring-[#8da399]/20 outline-none transition" placeholder="HH:mm" onblur="formatCustomTime(this)">
                        </div>
                    </div>

<div id="noteContainer">
            <div>
              <label class="block text-xs text-[#7a8f85] mb-1.5 uppercase tracking-wide font-medium">å…§å®¹ç´€éŒ„</label>
              <textarea id="caseNote" rows="3" class="w-full border border-[#e8e2da] bg-[#faf9f7] rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-[#8da399]/20 transition"></textarea>
            </div>
          </div>

          <div class="flex justify-end gap-3 pt-4">
            <button type="button" onclick="closeModal()" class="px-4 py-2 text-sm text-[#8da399] font-medium hover:bg-[#f5f2ed] rounded-lg transition">å–æ¶ˆ</button>
            <button type="submit" class="px-6 py-2 bg-[#8da399] text-white rounded-lg text-sm hover:bg-[#7a8f85] transition shadow-sm">å„²å­˜æª”æ¡ˆ</button>
          </div>
        </form> </div>
    </div>
  </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyChKcQgRMId5U6T_5n4XrJOn1aVwonotHY",
            authDomain: "journey-b7ba3.firebaseapp.com",
            projectId: "journey-b7ba3",
            storageBucket: "journey-b7ba3.firebasestorage.app",
            messagingSenderId: "999872038815",
            appId: "1:999872038815:web:1a9e733f870b438fba5faa"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        
        const APP_COLLECTION_ID = 'itinerary-global-sync-v2'; 

        let currentUser = null;
        let caseList = [];
        let syncUnsubscribe = null;
        const displayWeekDays = ["æ˜ŸæœŸæ—¥", "æ˜ŸæœŸä¸€", "æ˜ŸæœŸäºŒ", "æ˜ŸæœŸä¸‰", "æ˜ŸæœŸå››", "æ˜ŸæœŸäº”", "æ˜ŸæœŸå…­"];
        const periodNames = ["æ—©ä¿®", "ç¬¬ä¸€ç¯€", "ç¬¬äºŒç¯€", "ç¬¬ä¸‰ç¯€", "ç¬¬å››ç¯€", "åˆä¼‘", "ç¬¬äº”ç¯€", "ç¬¬å…­ç¯€", "ç¬¬ä¸ƒç¯€"];

        // ç™»å…¥
        document.getElementById('btn-login').onclick = async () => {
            try {
                const errBox = document.getElementById('auth-error');
                errBox.classList.add('hidden');
                await setPersistence(auth, browserLocalPersistence);
                await signInWithPopup(auth, provider);
            } catch (e) {
                console.error("Login Error:", e);
                document.getElementById('auth-error').innerText = "ç™»å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
                document.getElementById('auth-error').classList.remove('hidden');
            }
        };

        // ç™»å‡º
        document.getElementById('btn-logout').onclick = () => {
            if (syncUnsubscribe) syncUnsubscribe();
            signOut(auth);
        };

        // ç‹€æ…‹ç›£è½
        onAuthStateChanged(auth, (user) => {
            const overlay = document.getElementById('auth-overlay');
            const mainApp = document.getElementById('main-app');

            if (user) {
                currentUser = user;
                overlay.classList.add('hidden-auth');
                setTimeout(() => overlay.classList.add('hidden'), 300);
                mainApp.classList.remove('opacity-0');
                setupSync();
            } else {
                currentUser = null;
                overlay.classList.remove('hidden', 'hidden-auth');
                mainApp.classList.add('opacity-0');
            }
        });

        // æ ¸å¿ƒåŒæ­¥é‚è¼¯
        function setupSync() {
            if (!currentUser) return;
            const collectionRef = collection(db, 'artifacts', APP_COLLECTION_ID, 'users', currentUser.uid, 'itineraries');
            
            if (syncUnsubscribe) syncUnsubscribe();
            
            syncUnsubscribe = onSnapshot(collectionRef, (snapshot) => {
                caseList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderDisplay();
            }, (error) => {
                console.error("Sync error:", error);
            });
        }

        // UI æ¸²æŸ“
        function renderDisplay() {
            const now = new Date();
            const todayNum = now.getDay();
            const todayStr = now.toISOString().split('T')[0];
            
            document.getElementById('current-info').innerHTML = `
                <span class="text-[#8da399] mr-2">${displayWeekDays[todayNum]}</span> 
                <span class="text-[#b5a48d]/60 text-xs">${now.toLocaleDateString('zh-TW')}</span>
            `;

            const todayContainer = document.getElementById('today-container');
            const allContainer = document.getElementById('all-cases-container');
            todayContainer.innerHTML = '';
            allContainer.innerHTML = '';

            // æ ¸å¿ƒä¿®æ”¹ 2: æ’åºé‚è¼¯èª¿æ•´
            const sortedList = [...caseList].sort((a, b) => {
                // ä¸åŒé¡å‹æ™‚ï¼Œå–®æ¬¡è¡Œç¨‹å„ªå…ˆæ’åœ¨æœ€å‰é¢
                if (a.type !== b.type) return a.type === 'once' ? -1 : 1;

                if (a.type === 'once') {
                    // å–®æ¬¡è¡Œç¨‹æŒ‰æ—¥æœŸæ’åº
                    return (a.date || '').localeCompare(b.date || '');
                } else {
                    // å›ºå®šè¡Œç¨‹ï¼šæ ¹æ“šä»Šå¤©æ˜ŸæœŸå¹¾é€²è¡Œå¾ªç’°æ’åº
                    // è¨ˆç®—è©²è¡Œç¨‹ç›¸å°æ–¼ä»Šå¤©çš„åç§»å¤©æ•¸ (0-6)
                    const getOffset = (day) => (day - todayNum + 7) % 7;
                    const offsetA = getOffset(a.day);
                    const offsetB = getOffset(b.day);
                    
                    if (offsetA !== offsetB) return offsetA - offsetB;
                    // åŒä¸€å¤©çš„æŒ‰æ™‚æ®µæ’åº
                    return (a.period === 'custom' ? 99 : a.period) - (b.period === 'custom' ? 99 : b.period);
                }
            });

            const todayPendingCases = sortedList.filter(c => {
                const isExpired = isPeriodExpired(c.period, c.customTime);
                if (c.type === 'once') return c.date === todayStr && !isExpired;
                return c.day == todayNum && !isExpired;
            });

            if (todayPendingCases.length === 0) {
                todayContainer.innerHTML = `<div class="col-span-full py-10 text-center text-[#b5a48d]/50 text-sm">ä»Šæ—¥ç„¡å¾…è¾¦è¡Œç¨‹</div>`;
            } else {
                todayPendingCases.forEach(item => todayContainer.appendChild(createCard(item, true)));
            }

            if (sortedList.length === 0) {
                allContainer.innerHTML = `<div class="col-span-full py-10 text-center text-[#b5a48d]/40 text-sm">å°šæœªå»ºç«‹ä»»ä½•è¡Œç¨‹ã€‚</div>`;
            } else {
                sortedList.forEach(item => {
                    let isToday = (item.type === 'once') ? (item.date === todayStr) : (item.day == todayNum);
                    const isExpired = isPeriodExpired(item.period, item.customTime);
                    allContainer.appendChild(createCard(item, false, isToday && isExpired));
                });
            }
        }

function isPeriodExpired(period, customTimeValue) {
    const now = new Date();
    const currentHour = now.getHours();

    // 1. è™•ç†è‡ªå®šç¾©æ™‚é–“ (é€™éƒ¨åˆ†ä»éœ€è€ƒæ…®åˆ†é˜ï¼Œä»¥ç¶­æŒæº–ç¢ºæ€§)
    if (period === 'custom' && customTimeValue) {
        const [h, m] = customTimeValue.split(':').map(Number);
        return (currentHour > h) || (currentHour === h && now.getMinutes() >= m);
    }

    // 2. è™•ç†å›ºå®šæ™‚æ®µ (æ•´é»åˆ¤æ–·)
    const p = parseInt(period);
    
    if (p <= 1) return currentHour >= 10; // æ—©ä¿®ã€ç¬¬ä¸€ç¯€ï¼š10é»å¾ŒéæœŸ
    if (p <= 3) return currentHour >= 12; // ç¬¬äºŒç¯€ã€ç¬¬ä¸‰ç¯€ï¼š12é»å¾ŒéæœŸ
    if (p <= 5) return currentHour >= 14; // ç¬¬å››ç¯€ã€åˆä¼‘ï¼š14é»å¾ŒéæœŸ
    if (p <= 8) return currentHour >= 16; // ç¬¬äº”ã€å…­ã€ä¸ƒç¯€ï¼š16é»å¾ŒéæœŸ

    return false;
}

function createCard(item, isPending, isExpired) {
    const card = document.createElement('div');
    card.className = `case-card rounded-xl border shadow-sm ${isExpired ? 'opacity-40' : 'opacity-100'} ${isPending ? 'border-[#8da399] ring-1 ring-[#8da399]/10' : 'border-[#e8e2da]'}`;
    const periodStr = item.period === 'custom' ? item.customTime : periodNames[item.period];
    const titleClass = item.type === 'once' ? 'title-once' : 'title-weekly';
    const note = item.note || '';

    // é‚è¼¯ï¼šå¦‚æœæ˜¯å›ºå®šè¡Œç¨‹ (weekly)ï¼Œä¸€å¾‹é¡¯ç¤ºæ¡†ï¼›å¦‚æœæ˜¯å–®æ¬¡é ç´„ (once)ï¼Œä¸€å¾‹ä¸é¡¯ç¤ºæ¡†
    const shouldShowNote = (item.type === 'weekly');

    card.innerHTML = `
        <div class="p-5 flex flex-col h-full">
            <div class="flex justify-between items-start mb-3">
                <div>
                    <span class="text-[11px] text-[#9ba8a4] uppercase tracking-widest font-medium">${item.type === 'once' ? item.date.replace(/-/g, '/') : displayWeekDays[item.day]} Â· ${periodStr}</span>
                    <h3 class="${titleClass}">${item.name}</h3>
                </div>
                <div class="flex gap-1">
                    <button onclick="editCase('${item.id}')" class="p-1 text-[#b5a48d]/50 hover:text-[#8da399] transition"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></button>
                    <button onclick="deleteCase('${item.id}')" class="p-1 text-[#b5a48d]/50 hover:text-red-400 transition"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                </div>
            </div>
            ${shouldShowNote ? `
            <div class="mt-auto">
                <div id="display-note-${item.id}" onclick="startQuickEdit('${item.id}')" class="editable-note min-h-[40px] bg-[#faf9f7] ${!note ? 'border border-dashed border-[#e8e2da]' : ''}">
                   <p class="event-note-text whitespace-pre-line">${note}</p>
                </div>
<textarea 
    id="edit-note-${item.id}" 
    class="hidden w-full border border-[#8da399] bg-white rounded-lg px-2.5 py-1 event-note-text outline-none" 
    rows="1" 
    style="min-height: 32px; height: 32px; resize: none; overflow: hidden;" 
    oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'" 
    onblur="saveQuickEdit('${item.id}')">${note}</textarea>
            </div>
            ` : ''}
        </div>
    `;
    return card;
}
        // å…¨åŸŸæ§åˆ¶
        window.openModal = () => {
            document.getElementById('caseModal').classList.remove('hidden');
            setTimeout(() => document.getElementById('modalContent').classList.remove('scale-95', 'opacity-0'), 10);
            document.getElementById('caseForm').reset();
            document.getElementById('editId').value = '';
            window.setType('weekly');
        };

        window.closeModal = () => {
            const modalContent = document.getElementById('modalContent');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => document.getElementById('caseModal').classList.add('hidden'), 200);
        };

        window.setType = (type) => {
    document.getElementById('caseType').value = type;
    const btnWeekly = document.getElementById('btnWeekly');
    const btnOnce = document.getElementById('btnOnce');
    const noteContainer = document.getElementById('noteContainer');

    if (type === 'weekly') {
        btnWeekly.className = "flex-1 py-1.5 text-sm transition-colors type-btn-active";
        btnOnce.className = "flex-1 py-1.5 text-sm transition-colors bg-[#faf9f7] text-[#9ba8a4]";
        document.getElementById('weeklyOptions').classList.remove('hidden');
        document.getElementById('onceOptions').classList.add('hidden');
        noteContainer.classList.remove('hidden'); // å›ºå®šè¡Œç¨‹é¡¯ç¤ºå‚™è¨»
    } else {
        btnOnce.className = "flex-1 py-1.5 text-sm transition-colors type-btn-active";
        btnWeekly.className = "flex-1 py-1.5 text-sm transition-colors bg-[#faf9f7] text-[#9ba8a4]";
        document.getElementById('weeklyOptions').classList.add('hidden');
        document.getElementById('onceOptions').classList.remove('hidden');
        noteContainer.classList.add('hidden');    // å–®æ¬¡é ç´„éš±è—å‚™è¨»
    }
};

        window.checkCustomTime = (selectId, inputId) => {
            const select = document.getElementById(selectId);
            const input = document.getElementById(inputId);
            if (select.value === 'custom') { input.classList.remove('hidden'); input.focus(); } 
            else { input.classList.add('hidden'); }
        };

        window.formatCustomTime = (input) => {
            let val = input.value.replace(/[^0-9:]/g, '');
            if (val.length === 4 && !val.includes(':')) val = val.substring(0, 2) + ':' + val.substring(2);
            input.value = val;
        };

        window.editCase = (id) => {
            const item = caseList.find(c => c.id === id);
            if (!item) return;
            window.openModal();
            document.getElementById('editId').value = item.id;
            window.setType(item.type);
            document.getElementById('caseName').value = item.name;
            if (item.type === 'weekly') {
                document.getElementById('caseNote').value = item.note || '';
                document.getElementById('caseDay').value = item.day;
                document.getElementById('casePeriod').value = item.period;
                if (item.period === 'custom') {
                    const input = document.getElementById('customTimeWeekly');
                    input.value = item.customTime;
                    input.classList.remove('hidden');
                }
            } else {
                document.getElementById('caseDate').value = item.date;
                document.getElementById('casePeriodOnce').value = item.period;
                if (item.period === 'custom') {
                    const input = document.getElementById('customTimeOnce');
                    input.value = item.customTime;
                    input.classList.remove('hidden');
                }
            }
        };

        window.deleteCase = async (id) => {
            if (!currentUser || !confirm('ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ')) return;
            await deleteDoc(doc(db, 'artifacts', APP_COLLECTION_ID, 'users', currentUser.uid, 'itineraries', id));
        };

        window.startQuickEdit = (id) => {
            const displayEl = document.getElementById(`display-note-${id}`);
            const editEl = document.getElementById(`edit-note-${id}`);
            if (displayEl && editEl) {
                displayEl.classList.add('hidden'); editEl.classList.remove('hidden'); editEl.focus();
            }
        };

        window.saveQuickEdit = async (id) => {
            if (!currentUser) return;
            const editEl = document.getElementById('edit-note-' + id);
            const displayEl = document.getElementById('display-note-' + id);
            const newNote = editEl.value;
            displayEl.classList.remove('hidden'); editEl.classList.add('hidden');
            await setDoc(doc(db, 'artifacts', APP_COLLECTION_ID, 'users', currentUser.uid, 'itineraries', id), { note: newNote }, { merge: true });
        };

        document.getElementById('caseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return;
            
            const type = document.getElementById('caseType').value;
            const name = document.getElementById('caseName').value;
            const editId = document.getElementById('editId').value || Date.now().toString();
            
            let data = { type, name, updatedAt: serverTimestamp(), id: editId };
            if (type === 'weekly') {
                data.note = document.getElementById('caseNote').value;
                data.day = parseInt(document.getElementById('caseDay').value);
                data.period = document.getElementById('casePeriod').value;
                data.customTime = data.period === 'custom' ? document.getElementById('customTimeWeekly').value : null;
            } else {
                data.date = document.getElementById('caseDate').value;
                data.period = document.getElementById('casePeriodOnce').value;
                data.customTime = data.period === 'custom' ? document.getElementById('customTimeOnce').value : null;
                data.day = data.date ? new Date(data.date).getDay() : 0;
                data.note = ""; 
            }

            try {
                await setDoc(doc(db, 'artifacts', APP_COLLECTION_ID, 'users', currentUser.uid, 'itineraries', editId), data);
                window.closeModal(); 
            } catch (err) {
                console.error("Save error:", err);
            }
        });

        // æ¯ä¸€åˆ†é˜è‡ªå‹•æ›´æ–°ä¸€æ¬¡ä»‹é¢ï¼Œç¢ºä¿ä»Šæ—¥å¾…è¾¦è·Ÿéš¨æ™‚é–“æ›´æ–°
        setInterval(renderDisplay, 60000);
    </script>
</body>
</html>


